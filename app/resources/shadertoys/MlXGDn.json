{"Shader":{"ver":"0.1","info":{"id":"MlXGDn","date":"1420660971","viewed":1607,"name":"Palmetto Stalk","username":"eiffie","description":"Jack and the Palmetto Stalk by eiffie ... are these supposed to make sense? ","likes":20,"published":3,"flags":8,"tags":["plant"],"hasliked":0},"renderpass":[{"inputs":[],"outputs":[{"channel":"0"}],"code":"\/\/Jack and the Palmetto Stalk by eiffie\n\n#define time iGlobalTime\n#define size iResolution\n#define tex iChannel0\n\n#define TAO 6.283185\nfloat px;\nvec4 prp=vec4(0.0);\nfloat DE(in vec3 p){\n\tp.x+=sin(p.y)*0.25;\n\tfloat r=length(p.xz),y=p.y;\n\tif(r>1.75)return r-1.4;\n\tfloat trunk=r-0.1;\n\tp.y+=r*r*0.25;\n\tfloat a=atan(p.z,p.x);\n\tp.y=mod(p.y+a\/TAO,0.5)-0.25;\n\tfloat a2=mod(a+y*0.1,TAO\/8.0)-TAO\/16.0;\n\tp.xz=vec2(cos(a2),sin(a2))*r;\n\tfloat stem=length(vec3(p.x-clamp(p.x,-1.0,1.0),p.y,p.z))-0.005;\n\tp.x-=1.0;\n\tfloat r2=length(p.xz);\n\tfloat a1=atan(p.z,p.x);\n\ta2=mod(a1,0.2)-0.1;\n\tp.xz=vec2(cos(a2),sin(a2))*r2;\n\tp.x=clamp(p.x-0.4+a1*a1*0.02,0.0,0.4);\n\tp.yz=vec2(abs(p.z)-p.y,abs(p.z))*0.7;\n\tp=abs(p);\n\tfloat frond=max(p.x,max(p.y,p.z-0.025+r2*0.075+a1*a1*0.0025));\n\tif(prp.x<0.0)prp=vec4(r,a,a1,stem);\n\treturn min(min(stem,frond),trunk)*0.75;\n}\nfloat rnd(vec2 c){return fract(sin(dot(vec2(1.317,19.753),c))*413.7972);}\nvec3 noyz(vec3 c){return vec3(rnd(c.yz),rnd(c.zx),rnd(c.xy));}\nfloat rndStart(vec2 fragCoord){\n\treturn 0.5+0.5*rnd(fragCoord.xy);\n}\nvec3 Sky(vec3 rd){\n\treturn vec3(0.5+0.5*rd.y);\n}\nvec3 Color(vec3 ro, vec3 rd, float t, vec3 col){\n\tro+=rd*t;\n\tprp.x=-1.0;\n\tfloat d=DE(ro);\n\tvec2 e=vec2(px*t,0.0);\n\tvec3 L=normalize(vec3(0.5,0.8,-0.4));\n\tvec3 dn=vec3(DE(ro-e.xyy),DE(ro-e.yxy),DE(ro-e.yyx));\n\tvec3 dp=vec3(DE(ro+e.xyy),DE(ro+e.yxy),DE(ro+e.yyx));\n\tvec3 N=(dp-dn)\/(length(dp-vec3(d))+length(vec3(d)-dn));\n\tvec3 R=reflect(rd,N);\n\tvec3 lc=vec3(1.0,0.9,0.8),sc=vec3(0.5,0.9,0.4),rc=Sky(R);\n\tif(prp.x<0.11)sc=200.0*vec3(0.3,0.2,0.1)*mod(ro.y+0.033*prp.y,0.1)*mod(ro.y-0.05*prp.y,0.1);\n\telse if(prp.w>px*t)sc-=vec3(0.05,0.2,0.1)*abs(prp.z);\n\telse sc*=prp.x;\n\tvec3 scol=lc*(0.5+0.5*dot(N,L))*(sc+0.5*prp.x*rc*pow(max(0.0,dot(R,L)),2.0));\n\tcol=mix(scol,col,clamp(d\/(px*t),0.0,1.0));\n\treturn col;\n}\nvec2 sphDistances( in vec3 ro, in vec3 rd, in vec4 sph )\n{\/\/from iq's AA Sphere example\n\tvec3 oc = ro - sph.xyz;\n\tfloat b = dot( oc, rd );\n\tfloat c = dot( oc, oc ) - sph.w*sph.w;\n\tfloat h = b*b - c;\n\tfloat d = sqrt( max(0.0,sph.w*sph.w-h)) - sph.w;\n\treturn vec2( d, -b-sqrt(max(h,0.0)) );\n}\nfloat Face(vec2 p){\n\tfloat m=abs(p.y+0.5-p.x*p.x*0.4+sin(p.x*8.0)*0.05);\n\tfloat t=abs(mod(p.x+sin(p.x*10.0+p.y*10.0)*0.025,0.1)-0.05)*18.0;\n\tfloat d=max(m-clamp(pow(t,8.0),0.0,0.1),abs(p.x)-0.75);\n\tp.x=abs(p.x);\n\tp.x-=0.075;\n\td=min(d,length(vec2(p.x,p.y+p.x))-0.02);\n\tp.x-=0.25-p.y*0.1;p.y-=0.2;\n\td=min(d,length(vec2(p.x,p.y+p.x*0.25))-0.2);\n\treturn smoothstep(0.0,0.03,d);\n}\nvec2 rotate(vec2 v, float angle) {return cos(angle)*v+sin(angle)*vec2(v.y,-v.x);}\nvec3 Jack(vec3 ro, vec3 rd, vec3 col){\n\tvec4 sph=vec4(sin(time*0.3),ro.y-2.0+rd.y*0.5+cos(time*0.2),0.0,1.0);\n\tvec2 v=sphDistances(ro,rd,sph);\n\tif(v.y>0.0){\n\t\tif(v.x<px*v.y){\n\t\t\tro+=rd*v.y;\n\t\t\tro-=sph.xyz;\n\t\t\tvec3 N=normalize(ro+noyz(ro)*0.1);\n\t\t\tvec3 L=normalize(vec3(0.5,0.8,-0.4));\n\t\t\tvec3 R=reflect(rd,N);\n\t\t\tvec3 scol=vec3(1.0);\n\t\t\tscol+=pow(max(0.0,dot(R,L)),4.0);\n\t\t\tro.zy=rotate(ro.zy,0.5);\n\t\t\tscol*=Face(vec2(atan(ro.x,ro.z),ro.y));\n\t\t\tscol*=(0.5+0.5*dot(N,L));\n\t\t\tcol=mix(scol,col,clamp(v.x\/(px*v.y),0.0,1.0));\n\t\t}\n\t}\n\treturn col;\n}\nmat3 lookat(vec3 fw){\n\tfw=normalize(fw);vec3 rt=normalize(cross(fw,vec3(0.0,1.0,0.0)));return mat3(rt,cross(rt,fw),fw);\n}\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord ) {\n\tpx=1.5\/size.y;\n\tfloat tm=time*0.2;\n\tvec3 ro=vec3(sin(tm),-tm,cos(tm))*3.0;\n\tvec3 rd=lookat(vec3(-ro.x,-0.5+0.5*sin(tm*0.3),-ro.z))*normalize(vec3((2.0*fragCoord.xy-size.xy)\/size.y,2.0));\n\tfloat t=DE(ro)*rndStart(fragCoord),d=0.0,od=1.0;\n\tvec4 edge=vec4(-1.0);\n\tbool bGrab=false;\n\tfor(int i=0;i<96;i++){\n\t\tt+=d;\n\t\td=DE(ro+rd*t);\n\t\tif(d>od){\n\t\t\tif(bGrab && od<px*t && edge.x<0.0){\n\t\t\t\tedge=vec4(edge.yzw,t-od);\n\t\t\t\tbGrab=false;\n\t\t\t}\n\t\t}else bGrab=true;\n\t\tod=d;\n\t\tif(t>100.0 || d<0.00001)break;\n\t}\n\tif(d<px*t){\n\t\tif(edge.x>0.0)edge=edge.wxyz;\n\t\tedge=vec4(edge.yzw,t);\n\t}\n\tvec3 col=Sky(rd);\n\tfor(int i=0;i<4;i++){\n\t\tif(edge.w>0.0)col=Color(ro,rd,edge.w,col);\n\t\tedge=edge.wxyz;\n\t}\n\tcol=Jack(ro,rd,col);\n\tfragColor = vec4(col,1.0);\n\n}\n","name":"","description":"","type":"image"},{"inputs":[],"outputs":[{"channel":"0"}],"code":"\/\/this is a test of fake harmonics, one channel has a typical harmonics generating loop\n\/\/the other channel has the fakey\n\n#define bps 5.0\nfloat nofs(float n){\/\/the song's \"random\" ring\n    n=mod(n,8.0);\n    if(n<1.0)return -4.0;\n    if(n<2.0)return 0.0;\n    if(n<3.0)return -1.0;\n    if(n<4.0)return 3.0;\n    if(n<5.0)return 5.0;\n    if(n<6.0)return 0.0;\n    if(n<7.0)return -4.0;\n    return 2.0;\n}\nfloat scale(float note){\/\/throws out dissonant tones\n\tfloat n2=mod(note,12.0);\n\tif((n2==1.0)||(n2==4.0)||(n2==6.0)||(n2==9.0)||(n2==11.0))note=-100.0;\/\/minor\n\t\/\/if((n2==1.0)||(n2==2.0)||(n2==4.0)||(n2==8.0)||(n2==9.0)||(n2==11.0))note=-100.0;\/\/blues\n\treturn note;\n}\n#define TAO 6.283185\n\/\/ note number to frequency  from https:\/\/www.shadertoy.com\/view\/ldfSW2\nfloat ntof(float n){if(n<12.0)return 0.0;return 440.0 * pow(2.0, (n - 67.0) \/ 12.0);}\nfloat ssaw(float t){return 4.0*abs(fract(t)-0.5)-1.0;}\nfloat rnd(float t){return fract(sin(t*341.545234)*1531.2341);}\nfloat srnd(float t){float t2=fract(t);return mix(rnd(floor(t)),rnd(floor(t+1.0)),t2*t2*(3.0-2.0*t2));}\nvec2 harm(float x,float ps,float hm){\/\/phase shift, # of harmonics\n\tfloat sx=sign(mod(x,2.0)-1.0)+ps,afx=abs(fract(x)-0.5),p3=pow(afx*2.0,3.0);\n\tfloat a=mix(1.0-2.0*fract(x),-0.4+1.333*p3,ps);\n\ta+=sin(TAO*(x*(hm+0.5)+sx*0.25))*(0.3\/hm+1.2*p3\/hm);\n\ta*=pow(1.0-afx*2.0,0.25\/hm);\/\/fake\n\n\tfloat a2=0.0,s=1.0;\n\tfor(int i=0;i<100;i++){\/\/typical loop\n\t\tif(float(i)<hm){\n\t\t\ta2+=sin((x*s+ps)*TAO)\/s;\n\t\t\ts+=1.0;\n\t\t}else break;\n\t}\n\ta2*=0.5;\n\treturn vec2(a,a2);\n}\nvec2 inst(float n,float t,float bt,int i){\n\tfloat f=ntof(scale(n)),ps=0.0,hm=0.0;\n\tif(f<24.0)return vec2(0.0);\t\n\tif(i==0){ps=pow(bt*0.5,0.25);hm=floor(4.0+bt*20.0);}\n\t\/\/else if(i==1){ps=bt*0.5;hm=bt*0.05;f*=0.5;}\n\telse if(i==9){ps=bt*rnd(t);hm=100.0-40.0*bt;f*=0.5+0.5*rnd(t);}\n\tvec2 a=harm(f*t,ps,hm);\n\ta=sign(a)*pow(clamp(abs(a),0.0,1.0),vec2(70.0\/n));\n\ta*=exp(-bt*(0.8+float(i)))*min(min(bt,2.0-bt)*100.0,1.0)*60.0\/n*(0.8+0.2*rnd(n));\n\treturn a;\n}\nvec2 mainSound(float time)\n{\n\tint i0=0,i1=0,i1h=0,i2=0,i2h=0;\n\tfloat tim=time*bps,b=floor(tim);\n\tfloat t0=fract(tim),t1=mod(tim,2.0)*0.5,t2=mod(tim,4.0)*0.25;\n\tfloat n2=nofs(b*0.0625)+nofs(b*0.125)+nofs(b*0.25);\n\tfloat n1=n2+nofs(b*0.5),n0=n1+nofs(b);\n\n\tvec2 a0=inst(n0+72.0,time,t0,i0);\n\tvec2 a1=inst(n1+60.0,time,t1,i1);\n\tvec2 a1h=inst(n1+65.0,time*1.005,t1,i1h);\n\tvec2 a1hb=inst(n1+64.0,time,t1,9);\n\tvec2 a2=inst(n2+48.0,time,t2,i2);\n\tvec2 a2h=inst(n2+53.0,time,t2,i2h);\n\tvec2 v=0.25*(a0+a1+a1h+a1hb+a2+a2h);\n\t\n\t\/\/this is annoying to duplicate but it adds the note tails\n\tb-=1.0;\n\tn2=nofs(b*0.0625)+nofs(b*0.125)+nofs(b*0.25);\n\tn1=n2+nofs(b*0.5);n0=n1+nofs(b);\n\ta0=inst(n0+72.0,time,t0+1.0,i0);\n\tv+=0.25*a0;\n\tb-=1.0;\n\tn2=nofs(b*0.0625)+nofs(b*0.125)+nofs(b*0.25);\n\tn1=n2+nofs(b*0.5);\n\ta1=inst(n1+60.0,time,t1+1.0,i1);\n\ta1h=inst(n1+65.0,time*1.005,t1+1.0,i1h);\n\tv+=0.25*(a1+a1h);\n\tb-=2.0;\n\tn2=nofs(b*0.0625)+nofs(b*0.125)+nofs(b*0.25);\n\ta2=inst(n2+48.0,time,t2+1.0,i2);\n\ta2h=inst(n2+53.0,time,t2+1.0,i2h);\n\tv+=0.25*(a2+a2h);\n\treturn clamp(v,-1.0,1.0);\n}\n","name":"","description":"","type":"sound"}]}}